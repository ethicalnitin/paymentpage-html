<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dexter Payments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-gray-100">

    <header class="w-full bg-white shadow-md py-4 fixed top-0 left-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center">
                <img src="logo.jpeg" alt="Dexter Luxuries Logo" class="w-10 h-10 md:w-12 md:h-12 rounded-full mr-3">
                <h1 class="text-xl font-bold text-gray-800 uppercase tracking-wide">Dexter Luxuries</h1>
            </div>
            <div class="flex space-x-4">
                <a href="https://wa.me/9557338330" id="whatsappBtn" target="_blank" class="text-green-500 text-2xl hover:text-green-600 transition">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://t.me/dextersenior" target="_blank" class="text-blue-500 text-2xl hover:text-blue-600 transition">
                    <i class="fab fa-telegram"></i>
                </a>
            </div>
        </div>
    </header>

   <div class="flex flex-col items-center justify-center min-h-screen py-16 px-4 sm:px-6 lg:px-8 mt-16">
        <div class="w-full max-w-md bg-white p-6 rounded-lg shadow-lg text-center">
            <h1 class="text-2xl font-bold mb-4">Dexter Luxuries - Secure Payment Page</h1>

            <div class="flex gap-4 items-center justify-center">
                <a id="payWithBankAccount" href="#" class="transition-transform transform hover:scale-110">
                    <img src="https://i.ibb.co/6byJHWG/upi-icon.png" alt="Pay with Bank Account" class="h-24 w-24 object-contain" />
                    <p class="text-sm mt-1">Bank Account</p>
                </a>

                <a id="payWithUPI1" href="#" class="transition-transform transform hover:scale-110">
                    <img src="https://i.ibb.co/6byJHWG/upi-icon.png" alt="Pay with UPI-1" class="h-24 w-24 object-contain" />
                    <p class="text-sm mt-1">UPI-1</p>
                </a>

                <a id="payWithUPI2" href="#" class="transition-transform transform hover:scale-110">
                    <img src="https://i.ibb.co/6byJHWG/upi-icon.png" alt="Pay with UPI-2" class="h-24 w-24 object-contain" />
                    <p class="text-sm mt-1">UPI-2</p>
                </a>

                <a id="payWithUPI3" href="#" class="transition-transform transform hover:scale-110">
                    <img src="https://i.ibb.co/6byJHWG/upi-icon.png" alt="Pay with UPI-3" class="h-24 w-24 object-contain" />
                    <p class="text-sm mt-1">UPI-3</p>
                </a>
            </div>

           <div id="qrCodeContainer" class="hidden mt-4">
                <img id="qrCodeImage" src="" alt="QR Code" class="mx-auto mb-3" style="max-width: 200px; height: auto;">
                <p class="text-gray-600 text-sm">Scan the QR code above to complete your payment.</p>
            </div>


            <p class="text-blue-500 cursor-pointer mt-4 mb-2" onclick="openModal()">How will I get access?</p>
           <p class="text-red-500 cursor-pointer mb-4">
                <a href="https://wa.me/+919557338330?text=Payment%20error%20on%20Dexter%20Luxuries" target="_blank">Click here if payment error exists</a>
            </p>

            <div id="accessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm">
                    <h2 class="text-xl font-bold mb-4">How to Gain Access</h2>
                    <ol class="list-decimal list-inside text-left space-y-2">
                        <li>Complete the payment and submit your details.</li>
                        <li>Submit your registered email and username.</li>
                        <li>You will be redirected to WhatsApp for instant access.</li>
                    </ol>
                    <button class="mt-4 bg-green-500 text-white py-2 px-4 rounded" onclick="closeModal()">Close</button>
                </div>
            </div>

            <form id="paymentForm" class="space-y-4 mt-4" enctype="multipart/form-data">
                <div class="text-left">
                    <label for="amountDropdown" class="block text-sm font-medium text-gray-700">Amount (â‚¹)*</label>
                    <select id="amountDropdown" name="amountDropdown" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm p-2 bg-gray-100 text-gray-700" required>
                        <option value="399">â‚¹ 399</option>
                        <option value="499">â‚¹ 499</option>
                        <option value="999">â‚¹ 999</option>
                        <option value="1999">â‚¹ 1999</option>
                        <option value="1599">â‚¹ 1599</option>
                        <option value="3999">â‚¹ 3999</option>
                        <option value="5999">â‚¹ 5999</option>
                        <option value="custom">Custom Amount</option>
                    </select>
                </div>

                <div id="customAmountContainer" class="hidden text-left">
                    <label for="customAmount" class="block text-sm font-medium text-gray-700">Enter Custom Amount (â‚¹)*</label>
                    <input type="number" id="customAmount" name="customAmount" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm p-2" placeholder="Enter amount" min="1">
                </div>

                <div class="text-left">
                    <label for="utr" class="block text-sm font-medium text-gray-700">UTR / UPI Reference ID*</label>
                    <input type="text" id="utr" name="utr" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm p-2" placeholder="Enter UTR / UPI Reference ID" required>
                </div>

                <div class="text-left">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email*</label>
                    <input type="email" id="email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm p-2" placeholder="Enter your email" required>
                </div>

                <div class="text-left">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username (Optional)</label>
                    <input type="text" id="username" name="username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm p-2" placeholder="Enter your username (if applicable)">
                </div>

                <div class="text-left">
                    <label for="paymentScreenshot" class="block text-sm font-medium text-gray-700">Upload Payment Screenshot*</label>
                    <input type="file" id="paymentScreenshot" name="paymentScreenshot" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm p-2" accept="image/*" required>
                </div>

                <button type="submit" id="submitPaymentBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">Submit Payment</button>
            </form>


            <div id="paymentSuccessModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center">
                <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                    <h2 class="text-xl font-bold mb-4">Payment Successful!ðŸŸ©</h2>
                    <p class="mb-4">You will be redirected to WhatsApp in <span id="countdown">3</span> seconds...</p>
                    <button
                        id="closeModalBtn"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg"
                    >
                        Close
                    </button>
                </div>
            </div>

        <script>
        // --- Payment Method Button Handlers (Keep as is) ---
        const payWithBankAccountButton = document.getElementById('payWithBankAccount');
        const payWithUPI1Button = document.getElementById('payWithUPI1');
        const payWithUPI2Button = document.getElementById('payWithUPI2');
        const payWithUPI3Button = document.getElementById('payWithUPI3');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeImage = document.getElementById('qrCodeImage');

        // Define the QR codes (Keep as is)
        const upiQRCode ="https://branch-panel-data.s3.ap-south-1.amazonaws.com/images/qr_code/1744903445.png";
        const upi1QRCode = "https://branch-panel-data.s3.ap-south-1.amazonaws.com/images/qr_code/1744903445.png"; // Example different QR
        const upi2QRCode = "https://branch-panel-data.s3.ap-south-1.amazonaws.com/images/qr_code/1743184787.jpeg"; // Example different QR
        const upi3QRCode = "https://branch-panel-data.s3.ap-south-1.amazonaws.com/images/qr_code/1743864642.jpeg"; // Example different QR


        // Event listeners for "Pay with..." buttons (Keep as is)
        payWithBankAccountButton.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            qrCodeContainer.classList.remove('hidden');
            qrCodeImage.src = upiQRCode;
             // Optional: Hide other buttons if needed
        });

        payWithUPI1Button.addEventListener('click', (e) => {
             e.preventDefault();
            qrCodeContainer.classList.remove('hidden');
            qrCodeImage.src = upi1QRCode ;
        });

        payWithUPI2Button.addEventListener('click', (e) => {
             e.preventDefault();
            qrCodeContainer.classList.remove('hidden');
            qrCodeImage.src = upi2QRCode;
        });

        payWithUPI3Button.addEventListener('click', (e) => {
             e.preventDefault();
            qrCodeContainer.classList.remove('hidden');
            qrCodeImage.src = upi3QRCode;
        });


        // --- Modal Functions (Keep as is) ---
        function openModal() {
            const modal = document.getElementById('accessModal');
            modal.classList.remove('hidden');
            // Automatically close the modal after 4 seconds (adjust timing)
            // Removed the automatic close as it might be annoying, user can click Close
            // setTimeout(closeModal, 4000);
        }

        function closeModal() {
            const modal = document.getElementById('accessModal');
            modal.classList.add('hidden');
        }

        // --- URL Parameter Function (Keep as is) ---
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // --- DOM Content Loaded: Handle Amount Pre-filling ---
        document.addEventListener('DOMContentLoaded', function() {
            const amountDropdown = document.getElementById('amountDropdown');
            const customAmountContainer = document.getElementById('customAmountContainer');
            const customAmountInput = document.getElementById('customAmount'); // Get the custom amount input
            const urlAmount = getUrlParameter('amount'); // Get amount from URL

            console.log("Page loaded. URL amount:", urlAmount); // Debug log

            if (urlAmount) {
                // Check if the amount passed in the URL matches one of the dropdown values
                let isPreset = false;
                for (let i = 0; i < amountDropdown.options.length; i++) {
                    if (amountDropdown.options[i].value === urlAmount) {
                        amountDropdown.value = urlAmount; // Select the preset amount
                        isPreset = true;
                        console.log(`Preset amount found: ${urlAmount}. Dropdown set.`); // Debug log
                        break; // Found a match, exit loop
                    }
                }

                if (!isPreset) {
                    // If the amount isn't a preset, show custom amount input and populate it
                    amountDropdown.value = 'custom'; // Select the 'Custom Amount' option
                    customAmountContainer.classList.remove('hidden');
                    customAmountInput.value = urlAmount; // Set the custom input value
                    console.log(`Amount ${urlAmount} is not preset. Custom field shown.`); // Debug log
                     // Make the custom amount input required if using it
                    customAmountInput.required = true;
                } else {
                     // If a preset was found and selected, ensure custom field is hidden
                     customAmountContainer.classList.add('hidden');
                     customAmountInput.required = false; // Make custom input not required
                }
            } else {
                // If no amount in URL, set the default value of the dropdown
                amountDropdown.value = '399';
                customAmountContainer.classList.add('hidden'); // Ensure custom is hidden by default
                 customAmountInput.required = false; // Make custom input not required
                console.log("No amount in URL. Defaulting to 399."); // Debug log
            }

            // Show the custom amount field when 'custom' is selected in the dropdown
            amountDropdown.addEventListener('change', function() {
                if (amountDropdown.value === 'custom') {
                    customAmountContainer.classList.remove('hidden');
                    customAmountInput.required = true; // Make required when shown
                } else {
                    customAmountContainer.classList.add('hidden');
                     customAmountInput.required = false; // Make not required when hidden
                }
                 // Clear custom amount input if hiding it
                 if (customAmountContainer.classList.contains('hidden')) {
                      customAmountInput.value = '';
                 }
            });
        });

        // --- Form Submission Event Listener ---
        document.getElementById('paymentForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const submitPaymentBtn = document.getElementById('submitPaymentBtn');
            submitPaymentBtn.innerHTML = 'Processing...'; // Show loading state
            submitPaymentBtn.disabled = true; // Disable button to prevent multiple submissions

            const form = event.target;
            const formData = new FormData(form);

            // Get the selected amount - Correctly gets from dropdown or custom input
            const selectedAmount = formData.get('amountDropdown') === 'custom' ? formData.get('customAmount') : formData.get('amountDropdown');

            // Add the selected amount to the formData if you need to send it explicitly
            // The form already includes amountDropdown and customAmount, backend needs to handle which one to use
            // If you want a single 'amount' field in formData for the backend:
            // formData.set('amount', selectedAmount);


            // --- Facebook Pixel & CAPI Tracking (Keep as is) ---
            // Ensure selectedAmount is used for tracking
            if (window.fbq) {
                window.fbq('track', 'Purchase', {
                    value: parseFloat(selectedAmount), // Use parseFloat for value
                    currency: 'INR'
                });
            }

            try {
                const userAgent = navigator.userAgent;
                const capiResponse = await fetch('https://backend-cmfshop.onrender.com/track-event', { // Ensure this URL is correct
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Use application/json for CAPI endpoint
                    },
                    body: JSON.stringify({
                        event_name: 'Purchase',
                        event_time: Math.floor(Date.now() / 1000),
                        action_source: 'website',
                        event_source_url: window.location.href,
                        custom_data: {
                            value: parseFloat(selectedAmount), // Use parseFloat for value
                            currency: 'INR'
                        },
                        user_data: {
                            client_user_agent: userAgent,
                             // You might want to add email or other user data here if available and hashed
                             email: data.email ? CryptoJS.SHA256(data.email.toLowerCase()).toString() : undefined, // Example Hashing
                             phone: undefined, // Add if you collect phone
                             client_ip_address: undefined, // Should get on backend typically
                        }
                         // context: {...} // Add context if needed
                    }),
                });
                const capiResult = await capiResponse.json();
                console.log('Purchase event sent via CAPI:', capiResult);
            } catch (error) {
                console.error('Error sending Purchase via CAPI:', error);
            }

            // --- Send Form data to backend for Telegram/Verification ---
            // This assumes your backend '/submit' endpoint is expecting FormData including the file.
            try {
                 // Create a new FormData object to potentially add selectedAmount explicitly
                 const dataToSend = new FormData(form); // Start with the original form data
                 dataToSend.set('amount', selectedAmount); // Explicitly add the determined amount

                const telegramResponse = await fetch('https://backend-cmfshop.onrender.com/submit', { // Ensure this URL is correct
                    method: 'POST',
                    // Do NOT set Content-Type header for FormData with file uploads; browser does it.
                    body: dataToSend // Send the FormData object directly, including file upload
                });

                if (telegramResponse.ok) {
                    console.log('Form data sent successfully');
                    // You might want to show a different success message or redirect based on backend response
                } else {
                    console.error('Error sending form data:', await telegramResponse.text()); // Log text response on error
                    alert("Failed to submit payment details. Please try again."); // Alert user
                     submitPaymentBtn.innerHTML = 'Submit Payment'; // Reset button text
                     submitPaymentBtn.disabled = false; // Re-enable button
                    return; // Stop here if form submission failed
                }
            } catch (error) {
                console.error('Error processing form submission:', error);
                 alert("Failed to submit payment details. Please try again."); // Alert user
                 submitPaymentBtn.innerHTML = 'Submit Payment'; // Reset button text
                 submitPaymentBtn.disabled = false; // Re-enable button
                 return; // Stop here if form submission failed
            }


            // --- Display Success Modal and Redirect (Keep as is) ---
            // This part runs IF the fetch requests above completed without throwing errors.
            const successModal = document.getElementById('paymentSuccessModal');
            const countdownElement = document.getElementById('countdown');
            const closeModalBtn = document.getElementById('closeModalBtn');


            successModal.classList.remove('hidden');

            let countdown = 3;
            countdownElement.textContent = countdown; // Set initial countdown
            const countdownInterval = setInterval(() => {
                countdown -= 1;
                countdownElement.textContent = countdown;
                if (countdown === 0) {
                    clearInterval(countdownInterval);
                    // Remove the modal (optional, redirect happens next)
                    // successModal.classList.add('hidden');
                    // Redirect to WhatsApp
                    window.location.href = 'https://wa.me/+919557338330?text=I%20have%20submitted%20my%20payment%20details%20with%20UTR%20' + encodeURIComponent(data.utr || ''); // Include UTR in WhatsApp message
                }
            }, 1000); // Decrease countdown every second

            // Allow closing the modal early
             closeModalBtn.addEventListener('click', () => {
                 clearInterval(countdownInterval); // Stop countdown
                 successModal.classList.add('hidden'); // Hide modal
                  window.location.href = 'https://wa.me/+919557338330?text=I%20have%20submitted%20my%20payment%20details%20with%20UTR%20' + encodeURIComponent(data.utr || ''); // Redirect on close
             });


            // Reset the button state after redirect/modal logic starts
            // (These lines might be redundant if redirect happens fast, but good practice)
            submitPaymentBtn.innerHTML = 'Submit Payment';
            submitPaymentBtn.disabled = false;
        });

        // --- Manual Modal Trigger ---
        document.querySelector('.text-blue-500.cursor-pointer.mt-4.mb-2').onclick = openModal;


    </script>
        </div>
    </div>

</body>
</html>
